<!DOCTYPE html>
<html>
<head>
    <title>GrooveCircle</title>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/shared.css">
</head>
<body class="page">
    <!-- Nav Bar -->
    <div id="nav-bar" class="nav-bar">
        <a href="/groove" class="nav-link">Groove</a>
        <a href="/home" class="nav-link">Home</a>
        <a href="/activity" class="nav-link">Activity</a>
        <a href="/messagepage" class="nav-link">Messages</a>
        <a href="/profile" class="nav-link">Profile</a>
    </div>

    <!-- Groove Page -->
    <div class="container">
        <div class="groove-page-container">
            <h1>Groove</h1>

            <!-- Groove Button -->
            <div id="initial-view">
                <div class="groove-button-container">
                    <a href="#" class="btn-groove" id="groove-button">
                        <img src="/images/blueLogo.svg" alt="Groove" class="groove-logo">
                        <div class="btn-groove-text">Click to Groove!</div>
                    </a>
                </div>

                <!-- Waveform Container -->
                <div id="waveform-container" class="waveform-container" style="display: none;">
                    <div class="waves-wrapper">
                        <div class="wave"></div>
                        <div class="wave"></div>
                        <div class="wave"></div>
                        <div class="wave"></div>
                        <div class="wave"></div>
                        <div class="wave"></div>
                    </div>
                    <button id="cancel-groove" class="btn-primary">Quit Matching</button>
                </div>
            </div>

<!-- chatroom container (hidden by default) -->
<div id="chatroom-container" class="message-main-container" style="display: none;">
    <div style="display: flex; gap: 20px;">
        <!-- Sidebar for group members -->
        <div id="group-sidebar" class="group-sidebar">
            <h3>Group Members</h3>
            <div id="group-members-list">
                <!-- Members will be dynamically added here -->
            </div>
        </div>

        <!-- Conversation box -->
        <div style="width: 70%;">
            <div class="message-conversation-box" id="messages-area"></div>
            <div class="message-input-container">
                <input type="text" id="message-input" class="form-control" placeholder="Type your message here...">
                <button id="send-button" class="btn btn-primary">Send</button>
            </div>
        </div>
    </div>
</div>

    
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script src="/js/shared.js"></script>
</body>
</html>
<script>
    document.addEventListener('DOMContentLoaded', function () {
    const grooveButton = document.getElementById('groove-button');
    const waveformContainer = document.getElementById('waveform-container');
    const initialView = document.getElementById('initial-view');
    const chatroomContainer = document.getElementById('chatroom-container');
    const messagesArea = document.getElementById('messages-area');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const quitGrooveButton = document.getElementById('cancel-groove');
    const groupSidebar = document.getElementById('group-sidebar'); // Sidebar container
    const groupMembersList = document.getElementById('group-members-list'); // Members list container
    let activeChatroomId = null;

    // Function to get a cookie value
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    // Function to load group members into the sidebar
    async function loadGroupMembers(chatroomId) {
        try {
            const response = await fetch(`/chatroom/members`, {
                headers: { chatroomid: chatroomId }
            });

            if (!response.ok) throw new Error('Failed to fetch group members.');

            const data = await response.json();
            groupMembersList.innerHTML = ''; // Clear the list before adding new members

            data.members.forEach(member => {
                if (member.userid !== getCookie('spotify_id')) { // Exclude the current user
                    const memberItem = document.createElement('div');
                    memberItem.className = 'group-member-item';
                    memberItem.innerHTML = `
                        <p><strong>${member.username}</strong> (${member.userid})</p>
                    `;
                    groupMembersList.appendChild(memberItem);
                }
            });
        } catch (error) {
            console.error('Error loading group members:', error);
            groupMembersList.innerHTML = '<p>Failed to load group members.</p>';
        }
    }

    // Function to load chatroom data
    async function loadChatroom(chatroomId) {
        try {
            const response = await fetch(`/chatroom`, {
                headers: {
                    'chatroomid': chatroomId
                }
            });
            const data = await response.json();

            if (!data || !data.messages) {
                messagesArea.innerHTML = '<p>No messages yet. Start the conversation.</p>';
                return;
            }

            displayMessages(data.messages);

            // Load group members into the sidebar
            await loadGroupMembers(chatroomId);

            messagesArea.scrollTop = messagesArea.scrollHeight;
        } catch (error) {
            console.error('Error loading chatroom:', error);
            messagesArea.innerHTML = '<p>Failed to load conversation history.</p>';
        }
    }

    // Function to display messages
    async function displayMessages(messages) {
        messagesArea.innerHTML = ''; // Clear existing messages

        for (const message of messages) {
            const isCurrentUser = message.sender === getCookie('spotify_id');
            const messageDiv = document.createElement('div');
            messageDiv.className = `group-message-item ${isCurrentUser ? 'group-message-sent-message' : 'group-message-received-message'}`;
            messageDiv.innerHTML = `
                <div class="group-message-content-with-icon">
                    <div class="group-message-bubble">
                        <p>${message.message}</p>
                        <small>${new Date(message.timestamp).toLocaleTimeString()}</small>
                    </div>
                </div>
            `;
            messagesArea.appendChild(messageDiv);
        }

        messagesArea.scrollTop = messagesArea.scrollHeight;
    }

    grooveButton.addEventListener('click', async function (e) {
        e.preventDefault();

        const userid = getCookie('spotify_id');
        if (!userid) {
            console.error('No user ID found');
            return;
        }

        // Show waveform
        grooveButton.parentElement.style.display = 'none';
        waveformContainer.style.display = 'flex';

        try {
            const response = await fetch('/matching', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    userid
                }
            });

            if (!response.ok) throw new Error('Failed to start matching.');

            const data = await response.json();
            activeChatroomId = data.chatroomId;

            initialView.style.display = 'none';
            chatroomContainer.style.display = 'block';

            // Load chatroom and group members
            await loadChatroom(activeChatroomId);
        } catch (error) {
            console.error('Error starting matching:', error);
            waveformContainer.style.display = 'none';
            grooveButton.parentElement.style.display = 'block';
        }
    });

    sendButton.addEventListener('click', sendMessage);

    async function sendMessage() {
        const messageContent = messageInput.value.trim();
        const userid = getCookie('spotify_id');

        if (!activeChatroomId || !messageContent) {
            console.error('Missing chatroomId or message content');
            return;
        }

        try {
            const response = await fetch('/sendMessageGroup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    userid,
                    'chatroomid': activeChatroomId
                },
                body: JSON.stringify({ messageContent })
            });

            if (!response.ok) throw new Error('Failed to send message.');

            messageInput.value = '';
            await loadChatroom(activeChatroomId);
        } catch (error) {
            console.error('Error sending message:', error);
        }
    }

    // Auto-refresh chatroom every 3 seconds
    setInterval(() => {
        if (activeChatroomId) loadChatroom(activeChatroomId);
    }, 3000);
});
</script>