<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/shared.css">
    <style>
        .friend-selector {
            background-color: #2c2c2c;
            color: #ffffff;
            border: 1px solid #444;
            padding: 10px;
            font-size: 1em;
            width: 100%;
            margin-top: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .friend-selector option {
            background-color: #2c2c2c;
            color: #ffffff;
        }

        .song-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            margin-bottom: 15px;
        }

        .album-cover {
            width: 80px; 
            height: 80px;
            margin-bottom: 10px;
        }

        .song-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .scrollable-container {
            height: 80vh; /* Adjust as needed */
            overflow-y: auto;
            padding: 10px;
        }
    </style>
</head>
<body class="page">
    <div id="nav-bar" class="nav-bar">
        <a href="/groove" class="nav-link">Groove</a>
        <a href="/home" class="nav-link">Home</a>
        <a href="/activity" class="nav-link">Activity</a>
        <a href="/messagepage" class="nav-link">Messages</a>
        <a href="/profile" class="nav-link">Profile</a>
    </div>

    <div class="container">
        <h1>Home</h1>
        <h3>Recently Played Songs</h3>
        <select id="friend-selector" class="friend-selector">
            <option value="me" selected>My History</option>
        </select>
        <div id="song-history" class="scrollable-container"></div>
    </div>

    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script>
        $(document).ready(function () {
            const loggedInUserId = getCookie('spotify_id'); // Fetch logged-in user's ID
            let songOffset = 0; // Tracks the offset for "load more"
            const limit = 10; // Number of songs to fetch per request
            let currentFriendId = 'me'; // Tracks the currently selected user
            let loading = false; // Prevent multiple concurrent loads

            // Fetch song history for a user
            async function fetchSongHistory(userId, offset = 0, append = false) {
                if (loading) return; // Prevent loading if already in progress
                loading = true;

                try {
                    const response = await fetch('/songHistory', {
                        method: 'GET',
                        headers: { 
                            userid: userId,
                            limit: limit,
                            offset: offset
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Failed to fetch song history');
                    }

                    const data = await response.json();
                    const songHistoryContainer = $('#song-history');

                    if (!append) songHistoryContainer.empty(); // Clear if not appending

                    if (data.songHistory && data.songHistory.length > 0) {
                        data.songHistory.forEach(song => {
                            const songItem = `
                                <div class="song-item">
                                    <img src="${song.image.url}" alt="Album Cover" class="album-cover">
                                    <p class="song-title">${song.name}</p>
                                    <p class="song-artist">By: ${song.artist}</p>
                                </div>
                            `;
                            songHistoryContainer.append(songItem);
                        });
                    } else if (!append && offset === 0) {
                        songHistoryContainer.html('<p>No recent songs found.</p>');
                    }
                } catch (error) {
                    console.error('Error loading song history:', error);
                    $('#song-history').html('<p>Unable to load song history.</p>');
                } finally {
                    loading = false;
                }
            }

            // Fetch friends list
            async function fetchFriends() {
                try {
                    const response = await fetch('/friends?enrich=true', {
                        method: 'GET',
                        headers: { userid: loggedInUserId }
                    });

                    if (!response.ok) {
                        throw new Error('Failed to fetch friends');
                    }

                    const data = await response.json();
                    const friendSelector = $('#friend-selector');
                    friendSelector.empty();
                    friendSelector.append('<option value="me">My History</option>');

                    if (data.friendsList && data.friendsList.length > 0) {
                        for (const friendID of data.friendsList) {
                            const usernameResponse = await fetch('/Username', {
                                method: 'GET',
                                headers: { userid: friendID }
                            });
                            const usernameData = await usernameResponse.json();

                            friendSelector.append(
                                `<option value="${friendID}">${usernameData.username}</option>`
                            );
                        }
                    }
                } catch (error) {
                    console.error('Error loading friends list:', error);
                }
            }

            // Handle user selection change
            $('#friend-selector').on('change', function () {
                currentFriendId = $(this).val();
                songOffset = 0; // Reset offset
                fetchSongHistory(currentFriendId === 'me' ? loggedInUserId : currentFriendId);
            });

            // Infinite scroll to load more songs
            $('#song-history').on('scroll', function () {
                const container = $(this);
                if (
                    container.scrollTop() + container.innerHeight() >= container[0].scrollHeight - 10 &&
                    !loading
                ) {
                    songOffset += limit; // Increase offset
                    fetchSongHistory(
                        currentFriendId === 'me' ? loggedInUserId : currentFriendId,
                        songOffset,
                        true // Append new data
                    );
                }
            });

            // Initial load
            fetchSongHistory(loggedInUserId);
            fetchFriends();
        });

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }
    </script>
</body>
</html>
