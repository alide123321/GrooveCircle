<!DOCTYPE html>
<html>
<head>
    <title>GrooveCircle</title>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/shared.css">
</head>
<body class="page">
    <!-- Navigation bar -->
    <div id="nav-bar" class="nav-bar">
        <a href="/groove" class="nav-link">Groove</a>
        <a href="/home" class="nav-link">Home</a>
        <a href="/activity" class="nav-link">Activity</a>
        <a href="/messagepage" class="nav-link">Messages</a>
        <a href="/profile" class="nav-link">Profile</a>
    </div>

    <!-- Container for profile information -->
    <div class="container">
        <div id="user-profile"></div>
        <div id="oauth"></div>
        <!-- Button to obtain a new token using the refresh token -->
        <button id="obtain-new-token" class="btn btn-primary">Obtain new token using the refresh token</button>
        <!-- Logout button -->
        <button id="logout-button" class="btn btn-primary">Logout</button>
    </div>

    <!-- Handlebars template for displaying user profile information -->
    <script id="user-profile-template" type="text/x-handlebars-template">
      <h1>Welcome, {{display_name}}</h1>
      <div class="media">
        <div class="pull-left">
          <img class="media-object" width="150" src="{{images.0.url}}" />
        </div>
        <div class="media-body">
          <dl class="dl-horizontal">
            <dt>Display Name</dt><dd class="clearfix">{{display_name}}</dd>
            <dt>Id</dt><dd>{{id}}</dd>
            <dt>Email</dt><dd>{{email}}</dd>
            <dt>Spotify URI</dt><dd><a href="{{external_urls.spotify}}">{{external_urls.spotify}}</a></dd>
            <dt>Link</dt><dd><a href="{{href}}">{{href}}</a></dd>
            <dt>Country</dt><dd>{{country}}</dd>
          </dl>
        </div>
      </div>
    </script>

    <!-- Handlebars template for displaying OAuth information -->
    <script id="oauth-template" type="text/x-handlebars-template">
      <div class="oauth-container">
        <h2 class="section-title">OAuth Information</h2>
        <dl class="dl-horizontal">
          <dt>Access Token</dt><dd class="text-overflow">{{access_token}}</dd>
          <dt>Refresh Token</dt><dd class="text-overflow">{{refresh_token}}</dd>
        </dl>
      </div>
    </script>

    <!-- Handlebars and jQuery libraries -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>

    <!-- Shared JavaScript file, contains functions for authentication and profile data -->
    <script src="/js/shared.js"></script>
    <script>
        // Load profile data when page loads
        window.onload = function() {
            if (checkAuth()) {
                loadProfileData();
            }
        };

        function loadProfileData() {
            const access_token = getCookie('access_token');
            const refresh_token = getCookie('refresh_token');
            const userid = getCookie('spotify_id');

            var userProfileSource = document.getElementById('user-profile-template').innerHTML,
                userProfileTemplate = Handlebars.compile(userProfileSource),
                userProfilePlaceholder = document.getElementById('user-profile');

            var oauthSource = document.getElementById('oauth-template').innerHTML,
                oauthTemplate = Handlebars.compile(oauthSource),
                oauthPlaceholder = document.getElementById('oauth');

            // Render OAuth info
            oauthPlaceholder.innerHTML = oauthTemplate({
                access_token: access_token,
                refresh_token: refresh_token
            });

            // Load user profile
            $.ajax({
                url: 'https://api.spotify.com/v1/me',
                headers: {
                    'Authorization': 'Bearer ' + access_token
                },
                success: function(response) {
                    userProfilePlaceholder.innerHTML = userProfileTemplate(response);
                }
            });

            // Add event listeners
            document.getElementById('logout-button').addEventListener('click', () => {
                fetch('/logout', {
                    method: 'DELETE',
                    credentials: 'include'
                }).then(response => {
                    if (response.ok) {
                        window.location.href = '/';
                    } else {
                        alert('Logout failed');
                    }
                });
            });

            document.getElementById('obtain-new-token').addEventListener('click', function() {
                $.ajax({
                    url: '/refresh_token',
                    data: {
                        'userid': userid,
                        'refresh_token': refresh_token
                    }
                }).done(function(data) {
                    oauthPlaceholder.innerHTML = oauthTemplate({
                        access_token: getCookie('access_token'),
                        refresh_token: getCookie('refresh_token')
                    });
                });
            });
        }

        function getCookie(name) {
            let value = "; " + document.cookie;
            let parts = value.split("; " + name + "=");
            if (parts.length === 2) return parts.pop().split(";").shift();
        }
    </script>
</body>
</html>